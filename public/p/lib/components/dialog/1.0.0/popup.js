define(function(require){function Popup(){this.destroyed=!1,this.__popup=$("<div />").css({display:"none",position:"absolute",outline:0}).attr("tabindex","-1").html(this.innerHTML).appendTo("body"),this.__backdrop=this.__mask=$("<div />").css({opacity:.7,background:"#000"}),this.node=this.__popup[0],this.backdrop=this.__backdrop[0],_count++}var _count=0,_isIE6=!("minWidth"in $("html")[0].style),_isFixed=!_isIE6;return $.extend(Popup.prototype,{node:null,backdrop:null,fixed:!1,destroyed:!0,open:!1,returnValue:"",autofocus:!0,align:"bottom left",innerHTML:"",className:"ui-popup",show:function(anchor){if(this.destroyed)return this;var popup=this.__popup,backdrop=this.__backdrop;if(this.__activeElement=this.__getActive(),this.open=!0,this.follow=anchor||this.follow,!this.__ready){if(popup.addClass(this.className).attr("role",this.modal?"alertdialog":"dialog").css("position",this.fixed?"fixed":"absolute"),_isIE6||$(window).on("resize",$.proxy(this.reset,this)),this.modal){var backdropCss={position:"fixed",left:0,top:0,width:"100%",height:"100%",overflow:"hidden",userSelect:"none",zIndex:this.zIndex||Popup.zIndex};popup.addClass(this.className+"-modal"),_isFixed||$.extend(backdropCss,{position:"absolute",width:$(window).width()+"px",height:$(document).height()+"px"}),backdrop.css(backdropCss).attr({tabindex:"0"}).on("focus",$.proxy(this.focus,this)),this.__mask=backdrop.clone(!0).attr("style","").insertAfter(popup),backdrop.addClass(this.className+"-backdrop").insertBefore(popup),this.__ready=!0}popup.html()||popup.html(this.innerHTML)}return popup.addClass(this.className+"-show").show(),backdrop.show(),this.reset().focus(),this.__dispatchEvent("show"),this},showModal:function(){return this.modal=!0,this.show.apply(this,arguments)},close:function(result){return!this.destroyed&&this.open&&(void 0!==result&&(this.returnValue=result),this.__popup.hide().removeClass(this.className+"-show"),this.__backdrop.hide(),this.open=!1,this.blur(),this.__dispatchEvent("close")),this},remove:function(){if(this.destroyed)return this;this.__dispatchEvent("beforeremove"),Popup.current===this&&(Popup.current=null),this.__popup.remove(),this.__backdrop.remove(),this.__mask.remove(),_isIE6||$(window).off("resize",this.reset),this.__dispatchEvent("remove");for(var i in this)delete this[i];return this},reset:function(){var elem=this.follow;return elem?this.__follow(elem):this.__center(),this.__dispatchEvent("reset"),this},resize:function(){var elem=this.follow;return elem?this.__follow(elem):this.__center(),this.__dispatchEvent("resize"),this},focus:function(){var node=this.node,popup=this.__popup,current=Popup.current,index=this.zIndex=Popup.zIndex++;if(current&&current!==this&&current.blur(!1),!$.contains(node,this.__getActive())){var autofocus=popup.find("[autofocus]")[0];!this._autofocus&&autofocus?this._autofocus=!0:autofocus=node,this.__focus(autofocus)}return popup.css("zIndex",index),Popup.current=this,popup.addClass(this.className+"-focus"),this.__dispatchEvent("focus"),this},blur:function(){var activeElement=this.__activeElement,isBlur=arguments[0];return isBlur!==!1&&this.__focus(activeElement),this._autofocus=!1,this.__popup.removeClass(this.className+"-focus"),this.__dispatchEvent("blur"),this},addEventListener:function(type,callback){return this.__getEventListener(type).push(callback),this},removeEventListener:function(type,callback){for(var listeners=this.__getEventListener(type),i=0;i<listeners.length;i++)callback===listeners[i]&&listeners.splice(i--,1);return this},__getEventListener:function(type){var listener=this.__listener;return listener||(listener=this.__listener={}),listener[type]||(listener[type]=[]),listener[type]},__dispatchEvent:function(type){var listeners=this.__getEventListener(type);this["on"+type]&&this["on"+type]();for(var i=0;i<listeners.length;i++)listeners[i].call(this)},__focus:function(elem){try{this.autofocus&&!/^iframe$/i.test(elem.nodeName)&&elem.focus()}catch(e){}},__getActive:function(){try{var activeElement=document.activeElement,contentDocument=activeElement.contentDocument,elem=contentDocument&&contentDocument.activeElement||activeElement;return elem}catch(e){}},__center:function(){var popup=this.__popup,$window=$(window),$document=$(document),fixed=this.fixed,dl=fixed?0:$document.scrollLeft(),dt=fixed?0:$document.scrollTop(),ww=$window.width(),wh=$window.innerHeight(),ow=popup.width(),oh=popup.height(),left=(ww-ow)/2,top=(wh-oh)/2,style=popup[0].style;style.left=Math.max(parseInt(left),dl)+"px",style.top=Math.max(parseInt(top),dt)+"px"},__follow:function(anchor){var $elem=anchor.parentNode&&$(anchor),popup=this.__popup;if(this.__followSkin&&popup.removeClass(this.__followSkin),$elem){var o=$elem.offset();if(o.left*o.top<0)return this.__center()}var that=this,fixed=this.fixed,$window=$(window),$document=$(document),winWidth=$window.width(),winHeight=$window.height(),docLeft=$document.scrollLeft(),docTop=$document.scrollTop(),popupWidth=popup.width(),popupHeight=popup.height(),width=$elem?$elem.outerWidth():0,height=$elem?$elem.outerHeight():0,offset=this.__offset(anchor),x=offset.left,y=offset.top,left=fixed?x-docLeft:x,top=fixed?y-docTop:y,minLeft=fixed?0:docLeft,minTop=fixed?0:docTop,maxLeft=minLeft+winWidth-popupWidth,maxTop=minTop+winHeight-popupHeight,css={},align=this.align.split(" "),className=this.className+"-",reverse={top:"bottom",bottom:"top",left:"right",right:"left"},name={top:"top",bottom:"top",left:"left",right:"left"},temp=[{top:top-popupHeight,bottom:top+height,left:left-popupWidth,right:left+width},{top:top,bottom:top-popupHeight+height,left:left,right:left-popupWidth+width}],center={left:left+width/2-popupWidth/2,top:top+height/2-popupHeight/2},range={left:[minLeft,maxLeft],top:[minTop,maxTop]};$.each(align,function(i,val){temp[i][val]>range[name[val]][1]&&(val=align[i]=reverse[val]),temp[i][val]<range[name[val]][0]&&(align[i]=reverse[val])}),align[1]||(name[align[1]]="left"===name[align[0]]?"top":"left",temp[1][align[1]]=center[name[align[1]]]),className+=align.join("-")+" "+this.className+"-follow",that.__followSkin=className,$elem&&popup.addClass(className),css[name[align[0]]]=parseInt(temp[0][align[0]]),css[name[align[1]]]=parseInt(temp[1][align[1]]),popup.css(css)},__offset:function(anchor){var isNode=anchor.parentNode,offset=isNode?$(anchor).offset():{left:anchor.pageX,top:anchor.pageY};anchor=isNode?anchor:anchor.target;var ownerDocument=anchor.ownerDocument,defaultView=ownerDocument.defaultView||ownerDocument.parentWindow;if(defaultView==window)return offset;var frameElement=defaultView.frameElement,$ownerDocument=$(ownerDocument),docLeft=$ownerDocument.scrollLeft(),docTop=$ownerDocument.scrollTop(),frameOffset=$(frameElement).offset(),frameLeft=frameOffset.left,frameTop=frameOffset.top;return{left:offset.left+frameLeft-docLeft,top:offset.top+frameTop-docTop}}}),Popup.zIndex=1024,Popup.current=null,Popup});